<html>
<head>
  <script type="text/javascript" src="demo-libs/Bacon.min.js"></script>
  <script type="text/javascript" src="http://localhost:35729/livereload.js"></script>
  <script type="text/javascript" src="form-validation-kit.js"></script>
  <style>
    li {
      list-style: none;
      padding: 10px;
    }
    .demo, code {
      display: inline-block;
      padding: 2px 5px;
      color: #111;
      background-color: #CCC;
      white-space: pre;
      font-family: monospace;
      font-size: 12px;
      border-radius: 3px;
    }
    html {
      background-color: #EEE;
    }
    body {
      padding: 10px;
      max-width: 780px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: auto;
      background-color: #FFF;
    }
    .queue {
      padding: 0;
      position: relative;
      border: 1px solid #CCC;
      width: 50%;
      margin: 5px 0;
      background-color: #EEE;
    }
    .queue:before {
      content: "Input validator state history";
      position: absolute;
      bottom: -20;
      margin: auto;
      font-size: 10px;
    }
    .queue li {
      display: inline-block;
      height: 20px;
      width: 10%;
      padding: 0;
      font-size: 9px;
      overflow: hidden;
      text-align: center;
      line-height: 20px;
    }
    input[type=text] {
      padding: 5px;
      border: 1px solid #999;
      border-radius: 3px;
      border-style: inset;
    }
    input[type=submit] {
      padding: 5px;
      border-style: outset;
    }
    input:disabled {
      color: #333;
      opacity: 0.3;
    }
    .error {
      background-color: #C66;
    }
    .queued {
      background-color: #CC6;
    }
    .validating {
      background-color: #6CF;
    }
    .valid {
      background-color: #6C6;
    }
    .invalid {
      background-color: pink;
    }
    dt {
      display: inline-block;
      padding: 5px;
      border-radius: 3px;
    }
    dd {
      padding: 5px;
    }
    dl, ul {
      padding: 20px;
    }
  </style>
</head>
<body>
<script>
  var colors = {};
  colors[Validation.Error] = '#C66';
  colors[Validation.Queued] = '#CC6';
  colors[Validation.Validating] = '#6CF';
  colors[Validation.Valid] = '#6C6';
  colors[Validation.Invalid] = 'pink';
  var queue = {};
  var maxQueue = 10;
  function visualize(element) {
    return function(response) {
      element.className = response.state;
      element.nextElementSibling.textContent = '[' + response.state + '] ' + response.response ? response.response : "";

      var id = element.nextElementSibling.nextElementSibling.id;
      if (queue[id] === undefined) {
        queue[id] = [];
      }
      queue[id].unshift(response.state);
      queue[id] = queue[id].slice(0, maxQueue);

      element.nextElementSibling.nextElementSibling.innerHTML = queue[id].map(function(state) {
        return '<li class="' + state + '">' + state + "</li>";
      }).join("")
    }
  }
</script>
<h1>form-validation-kit</h1>
<p>form-validation-kit is a small library for handling the validation state of
  HTML forms.</p>
<p><a href="https://github.com/teijo/form-validation-kit">Project repository at Github</a></p>

<h2>Demos</h2>

<h3>Login</h3>

<p>This form demonstrates the library's capabilities. Each input utilizes
  different features of the library. Details after the demo.</p>

<p>For demo purposes, the state and its history are visualized for each input.
  It's not part of the library's functionality</p>
<form id="loginForm" autocomplete="off" onsubmit="loginListener(event)">
  <ul>
    <li>
      <p>Username</p>
      <input id="usernameInput" type="text" onkeyup="usernameListener(event)" />
      <label for="usernameInput"></label>
      <ul class="queue" id="usernameVisu"></ul>
    </li>
    <li>
      <p>Password</p>
      <input id="passwordInput" type="text" onkeyup="passwordListener(event)" />
      <label for="passwordInput"></label>
      <ul class="queue" id="passwordVisu"></ul>
    </li>
    <li>
      <p>Submit</p>
      <input id="loginSubmit" type="submit" />
      <label for="loginSubmit"></label>
      <ul class="queue" id="loginVisu"></ul>
    </li>
    <li>
      <p>Submission response</p>
      <input id="loginResponse" style="width: 50%" type="text" disabled="disabled" />
      <label for="loginResponse"></label>
      <ul class="queue" id="submitVisu"></ul>
    </li>
  </ul>
</form>
<h4>Form and validation description</h4>
<dl>
  <dt>Username</dt>
  <dd>Requires at least 1 character as input. Validated synchronously.
    Initialized with empty string.</dd>
  <dt>Password</dt>
  <dd>Input must be at least 1 character and maximum 2 characters long.
    Validated synchronouly but delayed by a debouncing, which is indicated by
    <span class="queued">QUEUED</span> state. Requires username to
    be in <span class="valid">VALID</span> state. Initialized with empty string.
  </dd>
  <dt>Submit</dt>
  <dd>Depends on the validation state of its parent validators, the Username
    and Password. Button is disabled unless both are <span class="valid">VALID</span>.
    Initializes to the calculated state of parent inputs.
  </dd>
  <dt>Submit response</dt>
  <dd>Triggered from form submission. Responds asynchronously with delay,
    indicated by <span class="validating">VALIDATING</span> state.
    Disables form while validation is ongoing. Resolves to
    <span class="valid">VALID</span> or <span class="invalid">INVALID</span>
    depending on whether username and password inputs match.
  </dd>
</dl>
<h4>Validation setup code</h4>
<script class="demo">
  // Helpers
  function el(id) { return document.getElementById(id); }

  // Assertions
  function min(value) { return (value.length > 0); }
  function max(value) { return (value.length < 3); }
  function processForm(value, done) {
    setTimeout(function() {
      var equal = value.username === value.password;
      done(equal, "Username and password are " + (!equal ? "not" : "") + " equal");
    }, 1000);
  }

  // Validators
  var username = Validation.create(function(state) {
    visualize(el('usernameInput'))(state);
    el('passwordInput').disabled = (state.state === Validation.Valid) ? '' : 'disabled';
  }, min).using('');

  var password = Validation.create(function(state) {
    visualize(el('passwordInput'))(state);
  }, min, max, username, {throttle: 500}).using('');

  Validation.create(function(state) {
    var element = el('loginSubmit');
    visualize(element)(state);
    element.disabled = (state.state === Validation.Valid) ? '' : 'disabled';
  }, username, password);

  var response = Validation.create(function(state) {
    var disabled = (state.state == Validation.Validating) ? 'disabled' : '';
    var inputs = el('loginForm').getElementsByTagName('input');
    Array.prototype.slice.call(inputs).forEach(function(el) {
      el.disabled = disabled;
    });
    var element = el('loginResponse');
    visualize(element)(state);
    element.value = state.response;
  }, processForm);

  // Input and form event handlers
  function usernameListener(event) {
    username.evaluate(event.target.value);
  }

  function passwordListener(event) {
    password.evaluate(event.target.value);
  }

  function loginListener() {
    event.preventDefault();
    response.evaluate({
      username: el('usernameInput').value,
      password: el('passwordInput').value
    });
  }
</script>

<h2>Validation states</h2>

<p>Validation can have the following states. If validator depends on other
  validators, active state is the state with highest precedence (top to bottom
  in list below) of all the used validators.</p>

<dl>
  <dt class="error">ERROR</dt>
  <dd>Validator could not correctly determine the validity of the input</dd>
  <dt class="queued">QUEUED</dd>
  <dd>Input received but validator invocation is waiting for throttle cooldown</dd>
  <dt class="validating">VALIDATING</dd>
  <dd>Validator invoked with latest value and waiting for response</dd>
  <dt class="invalid">INVALID</dd>
  <dd>Validator has evaluated input as invalid</dd>
  <dt class="valid">VALID</dd>
  <dd>Validator has evaluated input as valid</dd>
</dl>

<h2>API</h2>

<script class="demo">
  var syncAssertion = function(value) {
    if (isNaN(parseInt(value))) {
      throw new Error("Cannot asset non-number")
    } else {
      // Can also return non-true as invalid result response
      return value > 0;
    }
  };

  var asyncAssertion = function(value, done, error) {
    setTimeout(function() {
      if (isNaN(parseInt(value))) {
        error("Cannot asset non-number")
      } else {
        done(value > 0, "Value is less than 1")
      }
    }, 100);
  };

  var validator = Validation.create(
      function(state) { /*state changes*/},
      syncAssertion,
      /*, ...validators and assertions*/
      {throttle: 100/*last parameter can contain options*/});

  var inheritingValidator = Validation.create(
      function(state) {/*state changes*/},
      validator,
      asyncAssertion);

  validator.evaluate(1);
  inheritingValidator.evaluate(-1);
</script>
</body>
</html>
