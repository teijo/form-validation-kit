<html>
<head>
  <script type="text/javascript" src="demo-libs/Bacon.min.js"></script>
  <script type="text/javascript" src="http://localhost:35729/livereload.js"></script>
  <script type="text/javascript" src="form-validation-kit.js"></script>
  <style>
    li {
      list-style: none;
      padding: 10px;
    }
    .demo {
      display: block;
      padding: 5px;
      background-color: #EEE;
      white-space: pre;
      font-family: monospace;
      font-size: 11px;
    }
  </style>
</head>
<body onload="testInput()">
<script>
  function visualize(element) {
    return function(response) {
      var colors = {};
      colors[State.ERROR] = 'red';
      colors[State.WAITING] = 'lightgray';
      colors[State.VALIDATING] = 'aqua';
      colors[State.VALID] = 'lime';
      colors[State.INVALID] = 'pink';
      element.style.backgroundColor = colors[response.state];
      element.nextElementSibling.textContent = '[' + response.state + '] ' + response.errorMessageList.join(", ");
    }
  }
</script>
<h2>Sample validators</h2>
<script class="demo">
  function duplicateValidator(text) {
    return function(value, done) {
      setTimeout(function() {
        done(value !== text, 'Reserved word "' + text + '"');
      }, 50);
    }
  }

  function lengthValidator(minLength) {
    return function(value, done) {
      setTimeout(function() {
        done(value.length >= minLength, "Minimum length is " + minLength);
      }, 100);
    }
  }

  function regexpValidator(regexp) {
    return function(value, done) {
      done(value.match(regexp) !== null, "Not matching pattern " + regexp);
    }
  }

  function failingValidator(value, done, error) {
    setTimeout(function() {
      if (value.length > 5)
        error("Validation timed out, too long input");
      else
        done(true);
    }, 50);
  }
</script>
<h2>Sample form</h2>
<form>
  <dl>
    <li>
      <p>textHandler()</p>
      <input id="textInput" type="text" onkeyup="textHandler(event)" />
      <label for="textInput"></label>
    </li>
    <li>
      <p>numberHandler()</p>
      <input id="numberInput" type="text" onkeyup="numberHandler(event)"/>
      <label for="numberInput"></label>
    </li>
    <li>
      <p>failingHandler()</p>
      <input id="failingInput" type="text" onkeyup="failingHandler(event)"/>
      <label for="failingInput"></label>
    </li>
    <li>
      <input id="formSubmit" type="submit"/>
      <label for="formSubmit"></label>
    </li>
  </dl>
</form>
<script class="demo">
  var form = Form(function(state) {
    var submitButton = document.getElementById('formSubmit');
    submitButton.disabled = (state.state === State.VALID) ? '' : 'disabled';
    visualize(submitButton)(state);
  });

  var textValidation = form.validator(duplicateValidator("Test"), lengthValidator(6));
  var numberValidation = form.validator(regexpValidator(/^[0-9]*$/));
  var timeoutValidation = form.validator(failingValidator, {throttle: 1000});

  function textHandler(event) {
    textValidation.evaluate(event.target.value, visualize(event.target));
  }

  function numberHandler(event) {
    numberValidation.evaluate(event.target.value, visualize(event.target));
  }

  function failingHandler(event) {
    timeoutValidation.evaluate(event.target.value, visualize(event.target));
  }
</script>
<script>
  function emulateTyping(elementId, testInput, interval) {
    var node = document.getElementById(elementId);
    Bacon.sequentially(interval, testInput.split("")).onValue(function(char) {
      var event = new Event("keyup");
      event.keyCode = char.charCodeAt(0);
      node.value = node.value + char;
      node.dispatchEvent(event);
    });
  }
  function testInput() {
    emulateTyping('textInput', "Test some long text", 150);
    emulateTyping('numberInput', "1234ABCD", 400);
    emulateTyping('failingInput', "timeout", 300);
  }
</script>
</body>
</html>
