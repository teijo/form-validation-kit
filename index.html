<html>
<head>
  <script type="text/javascript" src="bower_components/bacon/dist/Bacon.js"></script>
  <script type="text/javascript" src="http://localhost:35729/livereload.js"></script>
  <script type="text/javascript" src="form-validation-kit.js"></script>
  <style>
    li {
      list-style: none;
      padding: 10px;
    }
  </style>
</head>
<body onload="emulateTyping()">
<form>
  <dl>
    <li>
      <input id="textInput" type="text" onkeyup="textInputHandler(event)" />
      <label for="textInput"></label>
    </li>
    <li>
      <input id="numberInput" type="text" onkeyup="numberInputHandler(event)"/>
      <label for="numberInput"></label>
    </li>
    <li>
      <input id="formSubmit" type="submit"/>
      <label for="formSubmit"></label>
    </li>
  </dl>
</form>
<script>
  function visualize(element) {
    return function(response) {
      var colors = {};
      colors[State.QUEUED] = 'lightgray';
      colors[State.PENDING] = 'aqua';
      colors[State.OK] = 'lime';
      colors[State.INVALID] = 'pink';
      element.style.backgroundColor = colors[response.state];
      element.nextElementSibling.textContent = response.errorMessageList.join(", ");
    }
  }

  function duplicateValidator(text) {
    return function(value, done) {
      setTimeout(function() {
        done(value !== text, 'Reserved word "' + text + '"');
      }, 50);
    }
  }

  function lengthValidator(minLength) {
    return function(value, done) {
      setTimeout(function() {
        done(value.length >= minLength, "Minimum length is " + minLength);
      }, 100);
    }
  }

  function regexpValidator(regexp) {
    return function(value, done) {
      done(value.match(regexp) !== null, "Not matching pattern " + regexp);
    }
  }

  function button() {
    var element = document.getElementById('formSubmit');
    var handler = visualize(element);
    return function(state) {
      element.disabled = (state.state === State.OK) ? '' : 'disabled';
      handler(state);
    }
  }

  var form = Form(button());

  var validateLengthAndDuplicates = form.validator(duplicateValidator("Test"), lengthValidator(6));
  var validateNumber = form.validator(regexpValidator(/^[0-9]*$/), lengthValidator(2));

  function textInputHandler(event) {
    validateLengthAndDuplicates.evaluate(event.target.value, visualize(event.target));
  }

  function numberInputHandler(event) {
    validateNumber.evaluate(event.target.value, visualize(event.target));
  }

  function emulateTyping() {
    var node = document.getElementById("textInput");
    var testInput = "Test Input";
    Bacon.sequentially(200, testInput.split("")).onValue(function(char) {
      var event = new Event("keyup");
      event.keyCode = char.charCodeAt(0);
      node.value = node.value + char;
      node.dispatchEvent(event);
    });
  }
</script>
</body>
</html>
