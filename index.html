<html>
<head>
  <script type="text/javascript" src="demo-libs/Bacon.min.js"></script>
  <script type="text/javascript" src="http://localhost:35729/livereload.js"></script>
  <script type="text/javascript" src="form-validation-kit.js"></script>
  <style>
    li {
      list-style: none;
      padding: 10px;
    }
    .demo, code {
      display: inline-block;
      padding: 2px 5px;
      color: #111;
      background-color: #CCC;
      white-space: pre;
      font-family: monospace;
      font-size: 12px;
      border-radius: 3px;
    }
    html {
      background-color: #EEE;
    }
    body {
      padding: 10px;
      max-width: 780px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: auto;
      background-color: #FFF;
    }
    .queue {
      padding: 0;
      position: relative;
      border: 1px solid #CCC;
      width: 50%;
      margin: 5px 0;
      background-color: #EEE;
    }
    .queue:before {
      content: "Input validator state history";
      position: absolute;
      bottom: -20;
      margin: auto;
      font-size: 10px;
    }
    .queue li {
      display: inline-block;
      height: 20px;
      width: 10%;
      padding: 0;
      font-size: 9px;
      overflow: hidden;
      text-align: center;
      line-height: 20px;
    }
    input[type=text] {
      padding: 5px;
      border: 1px solid #999;
      border-radius: 3px;
      border-style: inset;
    }
    input[type=submit] {
      padding: 5px;
      border-style: outset;
    }
    input[type=submit]:disabled {
      color: #333;
      opacity: 0.3;
    }
    .error {
      background-color: #C66;
    }
    .queued {
      background-color: #CC6;
    }
    .validating {
      background-color: #6CF;
    }
    .valid {
      background-color: #6C6;
    }
    .invalid {
      background-color: pink;
    }
    dt {
      display: inline-block;
      padding: 5px;
      border-radius: 3px;
    }
    dd {
      padding: 5px;
    }
    dl, ul {
      padding: 20px;
    }
  </style>
</head>
<body onload="testInput()">
<script>
  var colors = {};
  colors[Validation.Error] = '#C66';
  colors[Validation.Queued] = '#CC6';
  colors[Validation.Validating] = '#6CF';
  colors[Validation.Valid] = '#6C6';
  colors[Validation.Invalid] = 'pink';
  var queue = {};
  var maxQueue = 10;
  function visualize(element) {
    return function(response) {
//      element.style.backgroundColor = colors[response.state];
//      element.style.borderColor = colors[response.state];
      element.className = response.state;
      element.nextElementSibling.textContent = '[' + response.state + '] ' + response.errorMessages.join(", ");

      var id = element.nextElementSibling.nextElementSibling.id;
      if (queue[id] === undefined) {
        queue[id] = [];
      }
      queue[id].unshift(response.state);
      queue[id] = queue[id].slice(0, maxQueue);

      element.nextElementSibling.nextElementSibling.innerHTML = queue[id].map(function(state) {
        return '<li class="' + state + '">' + state + "</li>";
      }).join("")
    }
  }
</script>
<h1>form-validation-kit</h1>
<p>form-validation-kit is a small library for handling the validation state of
  HTML forms.</p>
<p><a href="https://github.com/teijo/form-validation-kit">Project repository at Github</a></p>

<h2>Demo form</h2>
<p>Filled on reload. Modify the inputs and play around. All fields are
  combined into a single form. All inputs need to be valid in order for the
  submit to be enabled.</p>
<form autocomplete="off">
  <ul>
    <li>
      <p>textHandler() validator</p>
      <input id="textInput" type="text" onkeyup="textHandler(event)" />
      <label for="textInput"></label>
      <ul class="queue" id="textVisu"></ul>
    </li>
    <li>
      <p>numberHandler() validator</p>
      <input id="numberInput" type="text" onkeyup="numberHandler(event)"/>
      <label for="numberInput"></label>
      <ul class="queue" id="numberVisu"></ul>
    </li>
    <li>
      <p>failingHandler() validator</p>
      <input id="failingInput" type="text" onkeyup="failingHandler(event)"/>
      <label for="failingInput"></label>
      <ul class="queue" id="failingVisu"></ul>
    </li>
    <li>
      <p>Combined validator state</p>
      <input id="formSubmit" type="submit"/>
      <label for="formSubmit"></label>
      <ul class="queue" id="formVisu"></ul>
    </li>
  </ul>
</form>

<h2>Sample validators</h2>
<p>Validator is a function determining determining the validity of the
  received input. Completed validation is indicated with <code>done</code> or
  <code>error</code> callbacks. If input is deemed INVALID, given message is
  returned to the validation requester. If unexpected problem occurs, such as
  a timeout for AJAX call, ERROR state can be triggered with desired
  description. Low granularity validators can be can be combined together
  (see below).</p>

<script class="demo">
  function duplicateValidator(text) {
    return function(value, done) {
      setTimeout(function() {
        done(value !== text, 'Reserved word "' + text + '"');
      }, 50);
    }
  }

  function lengthValidator(minLength) {
    return function(value, done) {
      setTimeout(function() {
        done(value.length >= minLength, "Minimum length is " + minLength);
      }, 1000);
    }
  }

  function regexpValidator(regexp) {
    return function(value, done) {
      done(value.match(regexp) !== null, "Not matching pattern " + regexp);
    }
  }

  function failingValidator(value, done, error) {
    setTimeout(function() {
      if (value.length > 5)
        error("Validation timed out, too long input");
      else
        done(true);
    }, 50);
  }
</script>

<h2>Demo form setup</h2>
<p><code>form</code> indicates a group of input <code>validator</code>s.
  <code>form</code> receives the combined state of the inputs, e.g. if one
  <code>validator</code> is INVALID and all others are VALID, combined result
  for the form is INVALID. If state of one <code>validator</code> is
  VALIDATING (result pending from asynchronous validation), state of
  <code>form</code> is VALIDATING. Precedence from first to last is listed below:</p>
<dl>
  <dt class="error">ERROR</dt>
  <dd>Validator could not correctly determine the validity of the input</dd>
  <dt class="queued">QUEUED</dd>
  <dd>Input received but validator invocation is waiting for throttle cooldown</dd>
  <dt class="validating">VALIDATING</dd>
  <dd>Validator invoked with latest value and waiting for response</dd>
  <dt class="invalid">INVALID</dd>
  <dd>Validator has evaluated input as invalid</dd>
  <dt class="valid">VALID</dd>
  <dd>Validator has evaluated input as valid</dd>
</dl>

<script class="demo">
  var form = Validation.Create(function(state) {
    var submitButton = document.getElementById('formSubmit');
    submitButton.disabled = (state.state === Validation.Valid) ? '' : 'disabled';
    visualize(submitButton)(state);
  });

  // Validators build from combining earlier definitions
  var textValidation = form.register(duplicateValidator("Test"), lengthValidator(6), {throttle: 500});
  var numberValidation = form.register(regexpValidator(/^[0-9]*$/), {throttle: 200});
  var timeoutValidation = form.register(failingValidator, {throttle: 1000});

  function textHandler(event) {
    textValidation.evaluate(event.target.value, visualize(event.target));
  }

  function numberHandler(event) {
    numberValidation.evaluate(event.target.value, visualize(event.target));
  }

  function failingHandler(event) {
    timeoutValidation.evaluate(event.target.value, visualize(event.target));
  }
</script>
<script>
  function emulateTyping(elementId, testInput, interval) {
    var node = document.getElementById(elementId);
    Bacon.sequentially(interval, testInput.split("")).onValue(function(char) {
      var event = new Event("keyup");
      event.keyCode = char.charCodeAt(0);
      node.value = node.value + char;
      node.dispatchEvent(event);
    });
  }
  function testInput() {
    emulateTyping('textInput', "Test some long text", 150);
    emulateTyping('numberInput', "1234ABCD", 400);
    emulateTyping('failingInput', "timeout", 300);
  }
</script>
</body>
</html>
